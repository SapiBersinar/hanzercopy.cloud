<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roast Namamu!</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1a202c, #2d3748);
            color: #e2e8f0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
            overflow-x: hidden;
        }
        /* Make 'hidden' class more aggressive */
        .hidden {
            display: none !important;
        }

        .container {
            background-color: #2f3645;
            border-radius: 1.5rem;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
            padding: 2.5rem;
            max-width: 700px;
            width: 100%;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.05);
            position: relative;
            z-index: 1;
            flex-shrink: 0;
            margin-top: auto;
            margin-bottom: auto;
            /* Initial state for main container fade-in */
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.8s ease-out, transform 0.8s ease-out;
        }
        .container.fade-in {
            opacity: 1;
            transform: translateY(0);
        }

        /* Responsiveness for smaller screens */
        @media (max-width: 640px) {
            .container {
                padding: 1.5rem;
            }
            .btn, .btn-secondary {
                padding: 0.75rem 1.5rem;
                font-size: 0.95rem;
            }
            .input-field, .select-field {
                padding: 0.65rem 1rem;
            }
            .api-key-card {
                padding: 1.5rem;
            }
            .api-key-card h2 {
                font-size: 1.75rem;
            }
            .roast-output p {
                font-size: 1rem;
            }
        }


        .btn {
            background-color: #ef4444;
            color: white;
            padding: 0.85rem 2rem;
            border-radius: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.05em;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
            border: none;
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.3);
        }
        .btn:hover {
            background-color: #dc2626;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
        }
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 3px 10px rgba(239, 68, 68, 0.2);
        }
        .btn-secondary {
            background-color: #4a5568;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease;
            cursor: pointer;
            border: none;
        }
        .btn-secondary:hover {
            background-color: #2d3748;
            transform: translateY(-2px);
        }
        .input-field, .select-field {
            background-color: #3e4451;
            color: #e2e8f0;
            border: 1px solid #5a6270;
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="#e2e8f0" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em;
            padding-right: 2.5rem;
        }
        .input-field:focus, .select-field:focus {
            outline: none;
            border-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.3);
        }
        .input-field::placeholder {
            color: #94a3b8;
        }
        .roast-output {
            background-color: #1f2937;
            border: 1px solid #374151;
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: left;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem;
            line-height: 1.6;
            color: #cbd5e1;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease;
            word-wrap: break-word;
            opacity: 0; /* Initial state for fade-in */
            transform: translateY(20px); /* Initial state for slide-up */
        }
        .roast-output.fade-in {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.8s ease-out, transform 0.8s ease-out; /* Animation properties */
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ef4444;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 1.5rem auto;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .message-box-content {
            background-color: #2f3645;
            color: #e2e8f0;
            border: 1px solid #5a6270;
        }
        .share-btn.whatsapp {
            background-color: #25D366;
        }
        .share-btn.whatsapp:hover {
            background-color: #1DA851;
        }

        /* API Key Modal Styling */
        #apiKeyModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .api-key-card {
            background-color: #1f2937;
            border-radius: 1.5rem;
            padding: 2.5rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .api-key-card h2 {
            font-size: 2.25rem;
            font-weight: 800;
            color: #ef4444;
            margin-bottom: 1.5rem;
        }
        .api-key-card p {
            color: #cbd5e1;
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }
        .api-key-card a {
            color: #60a5fa;
            text-decoration: underline;
        }
        .api-key-card input {
            background-color: #3e4451;
            color: #e2e8f0;
            border: 1px solid #5a6270;
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem;
            width: 100%;
            margin-bottom: 1.5rem;
            font-family: 'monospace';
        }
        .api-key-card input:focus {
            outline: none;
            border-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.3);
        }
        /* Style for displaying API Key info */
        #apiKeyInfo {
            background-color: #1f2937;
            border: 1px solid #374151;
            border-radius: 0.75rem;
            padding: 0.75rem;
            margin-bottom: 1.5rem;
            text-align: center;
            font-size: 0.9rem;
            color: #94a3b8;
            word-break: break-all;
        }
        /* On-screen Debugger */
        #onScreenDebugger {
            background-color: #333;
            color: #0f0;
            padding: 10px;
            margin-top: 15px;
            border-radius: 8px;
            font-family: 'monospace';
            font-size: 0.85rem;
            text-align: left;
            word-wrap: break-word;
            white-space: pre-wrap;
            max-height: 100px;
            overflow-y: auto;
            border: 1px solid #0a0;
        }
        #apiValidationMessage {
            color: #ef4444; /* Red for error messages */
            font-size: 0.9rem;
            margin-top: -1rem; /* Adjust spacing */
            margin-bottom: 1rem;
        }
        .checkbox-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 1rem;
            color: #cbd5e1;
        }
        .checkbox-container input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #ef4444; /* Tint checkbox red */
            cursor: pointer;
        }
        .saved-roasts-container {
            background-color: #1f2937;
            border: 1px solid #374151;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-top: 2rem;
            text-align: left;
        }
        .saved-roasts-list div {
            padding: 0.75rem;
            border-bottom: 1px solid #3e4451;
            display: flex;
            flex-direction: column; /* Allow content to wrap vertically */
            align-items: flex-start; /* Align text to left */
            justify-content: space-between;
        }
        .saved-roasts-list div:last-child {
            border-bottom: none;
        }
        .delete-roast-btn {
            background-color: #dc2626;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin-top: 0.5rem; /* Add margin for mobile touch target */
            align-self: flex-end; /* Align to the right in column layout */
        }
        .delete-roast-btn:hover {
            background-color: #b91c1c;
        }
        /* Mobile adjustments for saved roasts */
        @media (min-width: 640px) { /* Apply on screens wider than 640px (sm breakpoint) */
            .saved-roasts-list div {
                flex-direction: row; /* Back to row for wider screens */
                align-items: center; /* Center items in row */
            }
            .delete-roast-btn {
                margin-top: 0; /* Reset margin */
                align-self: auto; /* Reset alignment */
            }
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen flex flex-col items-center p-4">

    <!-- API Key Input Modal -->
    <div id="apiKeyModal">
        <div class="api-key-card">
            <h2>Butuh API Key! üîë</h2>
            <p>
                Untuk menggunakan aplikasi ini, Anda perlu memasukkan Google Gemini API Key Anda.
                Dapatkan API Key gratis Anda di
                <a href="https://aistudio.google.com/apikey" target="_blank" rel="noopener noreferrer">aistudio.google.com/apikey</a>.
            </p>
            <p>
                Atau, Anda bisa menyalin API Key yang sudah disediakan di sini:
                <a href="https://anotepad.com/notes/fdxactcr" target="_blank" rel="noopener noreferrer">anotepad.com/notes/fdxactcr</a>
            </p>
            <input type="text" id="apiKeyInput" placeholder="Tempel API Key Anda di sini (mis: AIzaSy...)" />
            <p id="apiValidationMessage" class="hidden"></p>
            <button id="submitApiKeyBtn" class="btn w-full">
                Gunakan API Key Ini
            </button>
            <div id="onScreenDebugger" class="hidden">
                <!-- Debug messages will appear here -->
            </div>
        </div>
    </div>

    <div id="mainContainer" class="container hidden"> <!-- Added hidden class and fade-in properties in CSS -->
        <h1 class="text-5xl font-extrabold text-red-400 mb-4">
            Ayo, Roast Namamu! üî•
        </h1>
        <p class="text-gray-400 mb-7 text-lg">
            Siap-siap mendengarkan kebenaran pahit yang lucu tentang namamu?
        </p>

        <!-- API Key Information Display -->
        <div id="apiKeyInfo" class="hidden">
            <p>API Key Aktif: <span id="currentApiKey" class="font-bold text-green-400"></span></p>
            <p class="text-xs mt-1 text-gray-500">Informasi nama/Gmail tidak dapat diakses untuk privasi Anda.</p>
        </div>

        <div class="space-y-5">
            <input
                type="text"
                id="nameInput"
                class="input-field w-full"
                placeholder="Masukkan namamu di sini (mis: Fulan bin Fulan)"
            />
            <input
                type="date"
                id="dobInput"
                class="input-field w-full"
                placeholder="Tanggal Lahir (DD/MM/YYYY)"
            />
            <input
                type="text"
                id="hobbyInput"
                class="input-field w-full"
                placeholder="Hobi/Minat (Opsional, mis: main game, baca buku)"
            />
            <div class="relative">
                <select id="styleSelect" class="select-field w-full">
                    <option value="satir_pedas">Gaya: Satir & Pedas (Default)</option>
                    <option value="receh_konyol">Gaya: Receh & Konyol</option>
                    <option value="formal_menohok">Gaya: Formal tapi Menohok</option>
                    <option value="anak_gaul">Gaya: Anak Gaul/Slang</option>
                    <option value="puitis_menyakitkan">Gaya: Puitis tapi Menyakitkan</option>
                    <option value="bijak_nylekit">Gaya: Bijak tapi Nylekit</option>
                    <option value="sinetron_drama">Gaya: Sinetron/Drama</option>
                    <option value="dokumenter_alam">Gaya: Dokumenter Alam</option>
                    <option value="iklan_produk_gagal">Gaya: Iklan Produk Gagal</option>
                    <option value="pedas_maksimal">Gaya: Pedas Level Maksimal üî•</option>
                    <option value="sindiran_kalem">Gaya: Sindiran Kalem tapi Jleb üòâ</option>
                    <option value="komika_standup">Gaya: Ala Komika Stand-up üòÇ</option>
                </select>
            </div>
            <div class="checkbox-container">
                <input type="checkbox" id="kidSafeMode">
                <label for="kidSafeMode">Mode Aman Anak (Kurang Pedas)</label>
            </div>
        </div>

        <button id="roastBtn" class="btn w-full">
            ROAST SEKARANG!
        </button>
        <button id="randomRoastBtn" class="btn-secondary w-full mt-4">
            Random Generate AI üé≤
        </button>
        <button id="resetInputBtn" class="btn-secondary w-full mt-4"> <!-- New Reset Input Button -->
            Reset Input
        </button>

        <div id="loadingSpinner" class="loading-spinner"></div>

        <div id="roastResults" class="roast-output mt-8">
            <p class="text-gray-500">Hasil roast akan muncul di sini. Bersiaplah...</p>
        </div>

        <div id="actionButtons" class="hidden flex flex-col sm:flex-row justify-center gap-4 mt-6">
            <button id="roastAgainBtn" class="btn-secondary">
                Roast Lagi!
            </button>
            <button id="copyRoastBtn" class="btn-secondary">
                Salin Roast
            </button>
            <button id="saveRoastBtn" class="btn-secondary">
                Simpan Roast ‚ù§Ô∏è
            </button>
        </div>

        <div id="shareButtons" class="hidden flex flex-col sm:flex-row justify-center gap-4 mt-4">
            <button id="shareWhatsappBtn" class="btn share-btn whatsapp">
                Bagikan ke WhatsApp
            </button>
        </div>

        <!-- Saved Roasts Container -->
        <div id="savedRoastsContainer" class="saved-roasts-container hidden">
            <h2 class="text-2xl font-bold text-gray-200 mb-4">Roast Tersimpan Anda</h2>
            <div id="savedRoastsList" class="saved-roasts-list space-y-2">
                <p class="text-gray-500 text-center">Belum ada roast yang disimpan.</p>
            </div>
        </div>
        <button id="toggleSavedRoastsBtn" class="btn-secondary w-full mt-4">
            Tampilkan Roast Tersimpan
        </button>


        <!-- Custom Message Box -->
        <div id="messageBox" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
            <div class="message-box-content rounded-xl p-7 shadow-2xl text-center max-w-sm w-full">
                <p id="messageText" class="text-gray-200 text-xl font-semibold mb-5"></p>
                <button id="closeMessageBox" class="btn w-full">Oke</button>
            </div>
        </div>

        <p class="text-gray-600 text-sm mt-8">
            <span class="text-red-400">Peringatan:</span> Konten ini murni untuk hiburan. Jangan anggap serius ya!
        </p>
    </div>

    <script type="module">
        let API_KEY = "";
        const LOCAL_STORAGE_KEY = 'roastAppSavedRoasts';

        // API Key Modal elements
        const apiKeyModal = document.getElementById('apiKeyModal');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const submitApiKeyBtn = document.getElementById('submitApiKeyBtn');
        const onScreenDebugger = document.getElementById('onScreenDebugger');
        const apiValidationMessage = document.getElementById('apiValidationMessage');

        // Main app elements
        const mainContainer = document.getElementById('mainContainer'); // Reference to the main content container
        const currentApiKeyDisplay = document.getElementById('currentApiKey');
        const apiKeyInfoDiv = document.getElementById('apiKeyInfo');

        const nameInput = document.getElementById('nameInput');
        const dobInput = document.getElementById('dobInput');
        const hobbyInput = document.getElementById('hobbyInput');
        const styleSelect = document.getElementById('styleSelect');
        const kidSafeModeCheckbox = document.getElementById('kidSafeMode');
        const roastBtn = document.getElementById('roastBtn');
        const randomRoastBtn = document.getElementById('randomRoastBtn');
        const resetInputBtn = document.getElementById('resetInputBtn'); // New: Reset Input button
        const roastResultsDiv = document.getElementById('roastResults');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const actionButtonsDiv = document.getElementById('actionButtons');
        const roastAgainBtn = document.getElementById('roastAgainBtn');
        const copyRoastBtn = document.getElementById('copyRoastBtn');
        const saveRoastBtn = document.getElementById('saveRoastBtn');
        const shareButtonsDiv = document.getElementById('shareButtons');
        const shareWhatsappBtn = document.getElementById('shareWhatsappBtn');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const closeMessageBox = document.getElementById('closeMessageBox');
        const savedRoastsContainer = document.getElementById('savedRoastsContainer');
        const savedRoastsList = document.getElementById('savedRoastsList');
        const toggleSavedRoastsBtn = document.getElementById('toggleSavedRoastsBtn');

        let lastGeneratedRoast = '';

        const loadingMessages = [
            "Memanggil roh-roh satir... harap sabar.",
            "Sedang meracik bumbu pedas untuk namamu.",
            "Kopi hitam dan ide gila sedang diseduh. Hampir jadi!",
            "Menyelami kegelapan hatimu untuk inspirasi. Santai saja.",
            "Otak AI sedang memanaskan mesinnya untuk 'roast' terbaik.",
            "Mohon menunggu, kebenaran pahit butuh waktu untuk disajikan.",
            "Mengkalibrasi tingkat kekejaman humor. Hampir selesai!",
            "Jangan panik, ini cuma proses kreatif yang agak 'gila'."
        ];

        const randomNames = ["Budi", "Siti", "Joko", "Ayu", "Kevin", "Putri", "Rizky", "Dewi", "Fulan", "Annisa", "Cici", "Dodo", "Erik", "Fitri", "Gilang"];
        const randomHobbies = ["main game", "baca buku", "nonton drakor", "berburu diskon", "tidur", "makan", "stalking sosmed", "ngoding", "nge-gym", "karaoke", "masak mie instan", "colek teman", "pura-pura sibuk", "scroll TikTok", "mikirin cicilan"];

        // --- On-screen Debugger Function ---
        function debugToScreen(message) {
            if (onScreenDebugger) {
                onScreenDebugger.classList.remove('hidden');
                onScreenDebugger.innerHTML += `<div>${message}</div>`;
                onScreenDebugger.scrollTop = onScreenDebugger.scrollHeight;
            }
            console.log("DEBUGGER:", message);
        }

        // --- Utility Functions ---
        function showMessageBox(message) {
            debugToScreen("Showing message box: " + message);
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
        }

        closeMessageBox.addEventListener('click', () => {
            debugToScreen("Closing message box.");
            messageBox.classList.add('hidden');
        });

        function temporaryButtonText(button, originalText, newText, duration = 2000) {
            button.textContent = newText;
            setTimeout(() => {
                button.textContent = originalText;
            }, duration);
        }

        // --- API Key Modal Logic ---
        function showApiKeyModal() {
            debugToScreen("showApiKeyModal called. Displaying modal.");
            apiKeyModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            apiKeyInput.focus();
            onScreenDebugger.innerHTML = '';
            onScreenDebugger.classList.remove('hidden');
            apiValidationMessage.classList.add('hidden');
            apiValidationMessage.textContent = '';
        }

        // Function to validate API Key using a dummy Gemini API call
        async function validateApiKey(key) {
            debugToScreen("Validating API Key: " + key.substring(0, 5) + "...");
            try {
                // A lightweight API call to verify the key
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`, {
                    method: 'GET'
                });

                if (response.ok) {
                    debugToScreen("API Key VALID. Status: " + response.status);
                    return true;
                } else {
                    const errorData = await response.json();
                    debugToScreen(`API Key INVALID. Status: ${response.status}. Error: ${errorData.error.message || 'Unknown error'}`);
                    return false;
                }
            } catch (error) {
                debugToScreen("API Key validation fetch error: " + error.message);
                // This typically means network error or CORS issue, not invalid key itself necessarily.
                // For simplicity, we treat it as invalid key in this context.
                return false;
            }
        }

        debugToScreen("Attempting to attach click listener to submitApiKeyBtn.");
        if (submitApiKeyBtn) {
            submitApiKeyBtn.addEventListener('click', async (event) => {
                event.preventDefault();
                debugToScreen("--- 'Gunakan API Key Ini' button HAS BEEN CLICKED! ---");
                const enteredKey = apiKeyInput.value.trim();
                debugToScreen("API Key entered: " + enteredKey);

                if (!enteredKey) {
                    apiValidationMessage.textContent = "Harap masukkan API Key Anda!";
                    apiValidationMessage.classList.remove('hidden');
                    debugToScreen("API Key input is empty.");
                    return;
                }

                apiValidationMessage.textContent = "Memverifikasi API Key...";
                apiValidationMessage.classList.remove('hidden');
                submitApiKeyBtn.disabled = true;

                const isValid = await validateApiKey(enteredKey);

                if (isValid) {
                    API_KEY = enteredKey;
                    debugToScreen("API_KEY global variable set to: " + API_KEY);
                    apiKeyModal.classList.add('hidden');
                    document.body.style.overflow = '';
                    mainContainer.classList.remove('hidden'); // Show main content
                    mainContainer.classList.add('fade-in'); // Trigger fade-in animation
                    currentApiKeyDisplay.textContent = API_KEY;
                    apiKeyInfoDiv.classList.remove('hidden');
                    debugToScreen("API Key modal hidden, main content shown, API Key info displayed.");
                    apiValidationMessage.classList.add('hidden');
                } else {
                    apiValidationMessage.textContent = "API Key tidak valid. Harap masukkan API Key yang benar.";
                    apiValidationMessage.classList.remove('hidden');
                    debugToScreen("API Key is invalid. Modal remains visible.");
                }
                submitApiKeyBtn.disabled = false;
            });
            debugToScreen("Event listener for submitApiKeyBtn ATTACHED successfully.");
        } else {
            debugToScreen("ERROR: Element with ID 'submitApiKeyBtn' NOT FOUND during script execution!");
        }

        // --- Saved Roasts Logic (Local Storage) ---
        function saveRoastToLocalStorage(roastText) {
            debugToScreen("Attempting to save roast to local storage.");
            try {
                let savedRoasts = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY)) || [];
                // Add a timestamp for unique ID and better display
                savedRoasts.push({
                    text: roastText,
                    timestamp: new Date().toLocaleString('id-ID', {
                        day: '2-digit',
                        month: 'short',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    })
                });
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(savedRoasts));
                debugToScreen("Roast saved successfully to local storage.");
                showMessageBox("Roast berhasil disimpan!");
                renderSavedRoasts(); // Re-render the list
            } catch (e) {
                debugToScreen("ERROR saving roast to local storage: " + e.message);
                showMessageBox("Gagal menyimpan roast. Browser mungkin penuh atau ada masalah.");
            }
        }

        function loadRoastsFromLocalStorage() {
            debugToScreen("Loading roasts from local storage.");
            try {
                return JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY)) || [];
            } catch (e) {
                debugToScreen("ERROR loading roasts from local storage: " + e.message);
                return [];
            }
        }

        function renderSavedRoasts() {
            debugToScreen("Rendering saved roasts.");
            const roasts = loadRoastsFromLocalStorage();
            savedRoastsList.innerHTML = ''; // Clear current list

            if (roasts.length === 0) {
                savedRoastsList.innerHTML = '<p class="text-gray-500 text-center">Belum ada roast yang disimpan.</p>';
            } else {
                roasts.forEach((roastObj, index) => {
                    const roastItem = document.createElement('div');
                    roastItem.className = 'flex flex-col sm:flex-row justify-between items-start sm:items-center py-2 text-sm';
                    roastItem.innerHTML = `
                        <div class="flex-grow text-gray-300">
                            <span class="font-bold text-red-300">${roastObj.timestamp}:</span> ${roastObj.text}
                        </div>
                        <button class="delete-roast-btn mt-2 sm:mt-0" data-index="${index}">Hapus</button>
                    `;
                    savedRoastsList.appendChild(roastItem);
                });

                // Add delete event listeners
                savedRoastsList.querySelectorAll('.delete-roast-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const indexToDelete = parseInt(event.target.dataset.index);
                        deleteRoast(indexToDelete);
                    });
                });
            }
        }

        function deleteRoast(index) {
            debugToScreen("Deleting roast at index: " + index);
            let savedRoasts = loadRoastsFromLocalStorage();
            if (index > -1 && index < savedRoasts.length) {
                savedRoasts.splice(index, 1); // Remove 1 element at the given index
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(savedRoasts));
                debugToScreen("Roast deleted. Re-rendering saved roasts.");
                renderSavedRoasts();
                showMessageBox("Roast berhasil dihapus!");
            }
        }

        // --- Main Roast Logic ---
        async function performRoast() {
            debugToScreen("performRoast function started.");
            if (!API_KEY) {
                showMessageBox("API Key belum dimasukkan. Harap masukkan API Key Anda terlebih dahulu!");
                showApiKeyModal();
                debugToScreen("API Key is missing, showing modal and returning from performRoast.");
                return;
            }
            debugToScreen("API Key found. Proceeding with roast generation. Key: " + API_KEY.substring(0, 5) + "...");

            const name = nameInput.value.trim();
            const dob = dobInput.value;
            const hobby = hobbyInput.value.trim();
            const selectedStyle = styleSelect.value;
            const isKidSafe = kidSafeModeCheckbox.checked;

            if (!name) {
                showMessageBox("Eits, mau di-roast tapi namanya kosong? Coba lagi!");
                debugToScreen("Name input is empty, returning.");
                return;
            }

            const randomLoadingMessage = loadingMessages[Math.floor(Math.random() * loadingMessages.length)];
            roastResultsDiv.innerHTML = `<p class="text-gray-500">${randomLoadingMessage}</p>`;
            roastResultsDiv.classList.remove('fade-in'); // Reset animation
            loadingSpinner.style.display = 'block';
            roastBtn.disabled = true;
            randomRoastBtn.disabled = true;
            actionButtonsDiv.classList.add('hidden');
            shareButtonsDiv.classList.add('hidden');
            debugToScreen("UI updated for loading state. Building prompt...");

            try {
                let chatHistory = [];
                let prompt = `Buatkan 'roast' nama yang sangat menghibur untuk nama "${name}".`;

                // Adjust prompt based on Kid-Safe Mode
                if (isKidSafe) {
                    prompt += ` Gunakan gaya bahasa yang sangat ringan, lucu, konyol, atau sedikit absurd. Hindari kata-kata atau sindiran yang terlalu pedas/menyinggung. Cocok untuk semua umur.`;
                } else {
                    // Original styles for normal mode
                    switch (selectedStyle) {
                        case 'satir_pedas':
                            prompt += ` Gunakan gaya bahasa sarkastik dan sedikit meremehkan, tapi tetap jenaka dan tidak benar-benar ofensif. Sertakan humor yang umum dan relatable.`;
                            break;
                        case 'receh_konyol':
                            prompt += ` Gunakan gaya bahasa yang receh, konyol, dan sedikit absurd. Fokus pada humor yang ringan dan membuat senyum.`;
                            break;
                        case 'formal_menohok':
                            prompt += ` Gunakan gaya bahasa formal dan sopan, namun dengan sindiran yang cerdas, halus, dan menohok. Buat terasa seperti kritik konstruktif yang disamarkan.`;
                            break;
                        case 'anak_gaul':
                            prompt += ` Gunakan gaya bahasa anak gaul atau slang yang kekinian. Buat terdengar santai, kocak, dan relatable bagi generasi muda.`;
                            break;
                        case 'puitis_menyakitkan':
                            prompt += ` Gunakan gaya bahasa puitis dengan sentuhan metafora atau perumpamaan yang indah, tetapi tetap mengandung sindiran lucu yang 'menyakitkan' secara humoris.`;
                            break;
                        case 'bijak_nylekit':
                            prompt += ` Gunakan gaya bahasa yang terdengar bijak atau seperti nasihat kehidupan, namun inti pesannya adalah sindiran tajam yang lucu. Buat terasa seperti wejangan yang menusuk.`;
                            break;
                        case 'sinetron_drama':
                            prompt += ` Gunakan gaya bahasa yang sangat dramatis dan berlebihan, seperti narasi di sinetron atau drama televisi. Penuh konflik dan emosi berlebihan.`;
                            break;
                        case 'dokumenter_alam':
                            prompt += ` Buatlah 'roast' ini seperti narasi dari dokumenter alam yang sedang mendeskripsikan suatu spesies (orang dengan nama ini). Gunakan istilah observasi, habitat, perilaku unik, dan kesimpulan 'ilmiah' yang lucu.`;
                            break;
                        case 'iklan_produk_gagal':
                            prompt += ` Buatlah 'roast' ini seperti ulasan atau iklan untuk produk yang gagal atau sangat aneh. Anggap nama ini adalah produknya, soroti 'fitur' lucunya, 'manfaat' yang aneh, dan 'kekurangan' fatal dengan gaya pemasaran yang satir.`;
                            break;
                        case 'pedas_maksimal':
                            prompt += ` Gunakan gaya bahasa yang sangat ekstrem dalam satir, sarkasme, dan 'pedas'. Jangan ragu untuk membuat sindiran yang tajam dan menusuk, tapi tetap dalam konteks humor yang tidak benar-benar ofensif secara personal. Ini adalah roast paling intens.`;
                            break;
                        case 'sindiran_kalem':
                            prompt += ` Gunakan gaya bahasa yang kalem, sopan, namun dengan sindiran yang sangat cerdas, implisit, dan 'jleb' di akhir. Humornya terselubung tapi sangat terasa.`;
                            break;
                        case 'komika_standup':
                            prompt += ` Sajikan roast ini seperti seorang komika stand-up yang sedang membawakan materi. Gunakan gaya bicara yang lugas, punchline yang jelas, dan penekanan pada aspek-aspek lucu dari nama atau orangnya.`;
                            break;
                        default:
                            prompt += ` Gunakan gaya bahasa sarkastik dan sedikit meremehkan, tapi tetap jenaka dan tidak benar-benar ofensif. Sertakan humor yang umum dan relatable.`;
                    }
                }


                if (dob) {
                    prompt += ` Anggap orang ini lahir pada tanggal ${dob}.`; // DOB for context, NO ZODIAC
                }
                if (hobby) {
                    prompt += ` Pertimbangkan juga hobinya: ${hobby}. Integrasikan hobi ini secara lucu ke dalam roast-nya.`;
                }

                prompt += ` Berikan satu paragraf panjang atau beberapa kalimat yang mengalir, bukan daftar poin.`;

                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;
                debugToScreen("Sending API request. Prompt length: " + prompt.length);

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    debugToScreen(`API response NOT OK. Status: ${response.status}. Error: ${errorData.error.message || 'Unknown'}`);
                    throw new Error(`Kesalahan API: ${response.status} - ${errorData.error.message || 'Respons tidak OK'}`);
                }

                const result = await response.json();
                debugToScreen("Gemini API raw response received.");

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    lastGeneratedRoast = result.candidates[0].content.parts[0].text;
                    roastResultsDiv.innerHTML = `<p>${lastGeneratedRoast}</p>`;
                    roastResultsDiv.classList.add('fade-in'); // Trigger animation
                    actionButtonsDiv.classList.remove('hidden');
                    shareButtonsDiv.classList.remove('hidden');
                    debugToScreen("Roast generated successfully.");
                } else {
                    roastResultsDiv.innerHTML = '<p class="text-red-400">Hmm, sepertinya API sedang malu-malu untuk me-roast. Coba lagi ya!</p>';
                    debugToScreen("Gemini API response structure unexpected or empty content.");
                }
            } catch (error) {
                debugToScreen('Error during roast generation: ' + error.message);
                roastResultsDiv.innerHTML = `<p class="text-red-400">Ups, ada yang tidak beres! ${error.message}. Coba periksa koneksi internetmu, atau namamu terlalu sempurna untuk di-roast?</p>`;
                showMessageBox(`Terjadi kesalahan: ${error.message}. Pastikan API key Anda valid dan Anda memiliki koneksi internet.`);
            } finally {
                loadingSpinner.style.display = 'none';
                roastBtn.disabled = false;
                randomRoastBtn.disabled = false;
                debugToScreen("Roast process finished. UI reset.");
            }
        }

        // --- Event Listeners ---
        roastBtn.addEventListener('click', performRoast);
        roastAgainBtn.addEventListener('click', performRoast);

        randomRoastBtn.addEventListener('click', () => {
            debugToScreen("Random Generate AI button clicked.");
            nameInput.value = randomNames[Math.floor(Math.random() * randomNames.length)];

            const randomYear = Math.floor(Math.random() * (2005 - 1980 + 1)) + 1980;
            const randomMonth = String(Math.floor(Math.random() * 12) + 1).padStart(2, '0');
            const randomDay = String(Math.floor(Math.random() * 28) + 1).padStart(2, '0');
            dobInput.value = `${randomYear}-${randomMonth}-${randomDay}`;

            hobbyInput.value = randomHobbies[Math.floor(Math.random() * randomHobbies.length)];
            styleSelect.value = styleSelect.options[Math.floor(Math.random() * styleSelect.options.length)].value;
            kidSafeModeCheckbox.checked = Math.random() < 0.5;

            performRoast();
        });

        // Event listener for Reset Input button
        resetInputBtn.addEventListener('click', () => {
            debugToScreen("Reset Input button clicked.");
            nameInput.value = '';
            dobInput.value = '';
            hobbyInput.value = '';
            styleSelect.value = 'satir_pedas'; // Reset to default style
            kidSafeModeCheckbox.checked = false; // Uncheck kid-safe mode
            roastResultsDiv.innerHTML = '<p class="text-gray-500">Hasil roast akan muncul di sini. Bersiaplah...</p>';
            roastResultsDiv.classList.remove('fade-in'); // Reset animation state
            actionButtonsDiv.classList.add('hidden');
            shareButtonsDiv.classList.add('hidden');
            debugToScreen("Input fields and results reset.");
        });

        copyRoastBtn.addEventListener('click', () => {
            debugToScreen("Copy Roast button clicked.");
            if (lastGeneratedRoast) {
                try {
                    const textarea = document.createElement('textarea');
                    textarea.value = lastGeneratedRoast;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    temporaryButtonText(copyRoastBtn, 'Salin Roast', 'Disalin!', 2000);
                    debugToScreen("Roast copied to clipboard.");
                } catch (err) {
                    debugToScreen('Failed to copy: ' + err.message);
                    showMessageBox('Gagal menyalin roast. Harap salin secara manual.');
                }
            } else {
                showMessageBox('Tidak ada roast untuk disalin!');
                debugToScreen("Attempted to copy, but no roast generated yet.");
            }
        });

        saveRoastBtn.addEventListener('click', () => {
            debugToScreen("Save Roast button clicked.");
            if (lastGeneratedRoast) {
                saveRoastToLocalStorage(lastGeneratedRoast);
            } else {
                showMessageBox('Tidak ada roast untuk disimpan!');
                debugToScreen("Attempted to save, but no roast generated yet.");
            }
        });

        toggleSavedRoastsBtn.addEventListener('click', () => {
            debugToScreen("Toggle Saved Roasts button clicked.");
            if (savedRoastsContainer.classList.contains('hidden')) {
                renderSavedRoasts();
                savedRoastsContainer.classList.remove('hidden');
                toggleSavedRoastsBtn.textContent = 'Sembunyikan Roast Tersimpan';
                debugToScreen("Saved roasts shown.");
            } else {
                savedRoastsContainer.classList.add('hidden');
                toggleSavedRoastsBtn.textContent = 'Tampilkan Roast Tersimpan';
                debugToScreen("Saved roasts hidden.");
            }
        });

        shareWhatsappBtn.addEventListener('click', () => {
            debugToScreen("Share WhatsApp button clicked.");
            if (lastGeneratedRoast) {
                const textToShare = encodeURIComponent(`Lihat roast namaku ini! üòÇ\n\n"${lastGeneratedRoast}"\n\nRoast namamu sendiri di: ${window.location.href}`);
                window.open(`https://api.whatsapp.com/send?text=${textToShare}`, '_blank');
            } else {
                showMessageBox('Tidak ada roast untuk dibagikan!');
                debugToScreen("Attempted to share, but no roast generated yet.");
            }
        });

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            debugToScreen("DOMContentLoaded fired. Initializing app. Ensuring API Key modal is visible and main container is hidden.");
            apiKeyInput.value = "";
            apiKeyModal.classList.remove('hidden');
            mainContainer.classList.add('hidden'); // Ensure main container is hidden initially
            showApiKeyModal();
        });
    </script>
</body>
</html>

