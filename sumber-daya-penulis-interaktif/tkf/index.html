<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Tokoh Sejarah/Legenda Fiksi - Hanzercopy</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Fallback font Inter */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden; /* Mencegah scroll horizontal */
        }
        /* Comic-like font */
        @import url('https://fonts.googleapis.com/css2?family=Comic+Neue:wght@700&family=Share+Tech+Mono&display=swap');
        .comic-font {
            font-family: 'Comic Neue', cursive;
        }
        .mono-font {
            font-family: 'Share Tech Mono', monospace; /* Font ala mesin tik/komputer */
        }
        /* Default font for inputs and general readability */
        .default-font {
            font-family: 'Inter', sans-serif;
        }

        /* Gaya khusus untuk tombol komik */
        .comic-button {
            border: 4px solid black;
            box-shadow: 6px 6px 0px black;
            transition: all 0.2s ease-in-out;
        }
        .comic-button:hover {
            box-shadow: 2px 2px 0px black;
            transform: translate(4px, 4px);
        }

        /* Loader spinner */
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }

        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Full-screen loading overlay */
        .loading-overlay-full {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* Overlay semi-transparan gelap */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100; /* Pastikan di atas semua elemen */
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none; /* Izinkan klik untuk melewati saat tidak aktif */
        }
        .loading-overlay-full.active {
            opacity: 1;
            pointer-events: auto;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 101;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            color: black;
            padding: 2rem;
            border-radius: 8px;
            border: 4px solid black;
            box-shadow: 8px 8px 0px black;
            text-align: center;
            max-width: 90%;
            width: 400px;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        .modal.active .modal-content {
            transform: translateY(0);
        }
        .modal-content h3 {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 1rem;
            font-family: 'Comic Neue', cursive;
        }
        .modal-content p {
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
            font-family: 'Inter', sans-serif;
        }
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }

        /* Styling for the output sections */
        .output-card {
            background-color: #e0e0e0; /* Light gray background */
            color: black;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #000;
            box-shadow: 4px 4px 0px #000;
            margin-top: 20px;
            text-align: left;
        }
        .output-card h3 {
            font-size: 1.6rem;
            font-weight: bold;
            margin-bottom: 10px;
            font-family: 'Comic Neue', cursive;
            border-bottom: 2px solid #000;
            padding-bottom: 5px;
        }
        .output-card p {
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        .output-card .detail-section {
            margin-top: 15px;
        }
        .output-card .detail-section strong {
            font-family: 'Comic Neue', cursive;
            font-size: 1.1rem;
        }
    </style>
</head>
<body class="bg-black text-white flex flex-col items-center p-4 min-h-screen">
    <div class="text-center space-y-6 max-w-4xl w-full p-6 bg-white text-black rounded-lg shadow-xl border-4 border-black mb-6">
        <h1 class="text-4xl sm:text-5xl md:text-6xl font-extrabold comic-font leading-tight">
            Generator Tokoh Sejarah/Legenda Fiksi
        </h1>
        <p class="text-lg sm:text-xl default-font">
            Ciptakan pahlawan, penjahat, atau figur berpengaruh untuk masa lalu dunia Anda!
        </p>

        <!-- API Key Input Section - Always visible initially -->
        <div id="api-key-section" class="w-full flex flex-col md:flex-row gap-4 items-center p-4 border-2 border-dashed border-gray-400 rounded-lg">
            <label for="api-key-input" class="comic-font text-lg text-gray-800 shrink-0 text-left md:text-center">API Key Anda untuk Generator Tokoh Sejarah:</label>
            <input type="text" id="api-key-input" placeholder="Masukkan API Key Gemini Anda di sini" class="flex-grow p-3 border-4 border-black rounded-lg text-black default-font text-base sm:text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button id="save-api-key-btn" class="comic-button bg-gray-600 text-white px-6 py-3 rounded-full text-lg font-bold w-full md:w-auto">
                Simpan API Key
            </button>
        </div>

        <!-- Main Content Area - Hidden until API Key is set -->
        <div id="main-content" class="hidden w-full space-y-6">
            <div class="w-full flex flex-col sm:flex-row gap-4 items-start justify-center">
                <!-- Left Column for Selects -->
                <div class="flex flex-col gap-4 w-full sm:w-1/2 md:w-2/5 lg:w-1/3">
                    <div class="flex flex-col gap-2 w-full">
                        <label for="figure-concept-input" class="comic-font text-gray-800 text-base shrink-0">Konsep Tokoh:</label>
                        <textarea id="figure-concept-input" placeholder="Misal: 'Seorang penemu gila yang menciptakan mesin waktu', 'Pahlawan pemberontak yang menyatukan suku-suku', 'Raja tiran yang berkuasa dengan sihir gelap'" class="flex-grow p-3 border-4 border-black rounded-lg text-black default-font text-base sm:text-lg focus:outline-none focus:ring-2 focus:ring-blue-500 min-h-[100px]"></textarea>
                        <button id="random-concept-btn" class="comic-button bg-purple-500 text-white px-4 py-2 rounded-full text-base font-bold mt-2 w-full">
                            <span id="random-concept-button-text">Acak Konsep!</span>
                            <div id="random-concept-loading-spinner" class="loader ease-linear rounded-full border-4 border-t-4 border-white h-4 w-4 ml-2 hidden"></div>
                        </button>
                    </div>

                    <div class="flex items-center gap-2 w-full">
                        <label for="figure-role-select" class="comic-font text-gray-800 text-base shrink-0">Peran Tokoh:</label>
                        <select id="figure-role-select" class="p-2 border-4 border-black rounded-lg text-black default-font text-base focus:outline-none focus:ring-2 focus:ring-blue-500 flex-grow">
                            <option value="Pahlawan">Pahlawan</option>
                            <option value="Penjahat/Tiran">Penjahat/Tiran</option>
                            <option value="Cendekiawan/Penemu">Cendekiawan/Penemu</option>
                            <option value="Mistikus/Penyihir">Mistikus/Penyihir</option>
                            <option value="Pemberontak/Revolusioner">Pemberontak/Revolusioner</option>
                            <option value="Penguasa/Raja">Penguasa/Raja</option>
                            <option value="Petualang">Petualang</option>
                            <option value="Penyair/Seniman">Penyair/Seniman</option>
                            <option value="Penjelajah/Pelaut">Penjelajah/Pelaut</option>
                            <option value="Pedagang/Kapitalis">Pedagang/Kapitalis</option>
                            <option value="Diplomat/Negosiator">Diplomat/Negosiator</option>
                            <option value="Jenderal/Strategi Militer">Jenderal/Strategi Militer</option>
                            <option value="Pembunuh/Mata-mata">Pembunuh/Mata-mata</option>
                            <option value="Tabib/Ilmuwan Medis">Tabib/Ilmuwan Medis</option>
                            <option value="Guru/Filsuf">Guru/Filsuf</option>
                            <option value="Lainnya">Lainnya</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2 w-full">
                        <label for="figure-era-select" class="comic-font text-gray-800 text-base shrink-0">Era/Periode:</label>
                        <select id="figure-era-select" class="p-2 border-4 border-black rounded-lg text-black default-font text-base focus:outline-none focus:ring-2 focus:ring-blue-500 flex-grow">
                            <option value="Kuno">Kuno</option>
                            <option value="Abad Pertengahan">Abad Pertengahan</option>
                            <option value="Renaisans">Renaisans</option>
                            <option value="Revolusi Industri">Revolusi Industri</option>
                            <option value="Modern">Modern</option>
                            <option value="Futuristik">Futuristik</option>
                            <option value="Pasca-Apokaliptik">Pasca-Apokaliptik</option>
                            <option value="Tidak Diketahui/Mitos" selected>Tidak Diketahui/Mitos</option>
                        </select>
                    </div>
                </div>
                
                <!-- Right Column for Context and Generate Button -->
                <div class="flex flex-col gap-4 w-full sm:w-1/2 md:w-3/5 lg:w-2/3">
                    <textarea id="figure-context-input" placeholder="Tambahkan konteks dunia atau budaya tempat tokoh ini berasal (Opsional: Misal: 'Dari Kekaisaran Matahari', 'Dibesarkan di gurun pasir', 'Hidup di kota melayang')." class="flex-grow p-3 border-4 border-black rounded-lg text-black default-font text-base sm:text-lg focus:outline-none focus:ring-2 focus:ring-blue-500 min-h-[100px]"></textarea>
                    
                    <button id="generate-figure-btn" class="comic-button bg-black text-white px-8 py-3 rounded-full text-lg font-bold w-full flex items-center justify-center">
                        <span id="button-text">Buat Tokoh!</span>
                        <div id="loading-spinner" class="loader ease-linear rounded-full border-4 border-t-4 border-white h-6 w-6 ml-3 hidden"></div>
                    </button>
                </div>
            </div>

            <div id="figure-output-section" class="relative p-6 border-4 border-black rounded-lg bg-gray-100 min-h-[400px] text-left text-gray-800 mono-font overflow-y-auto mt-6">
                <p class="text-center text-gray-600 comic-font text-lg pt-20" id="initial-message">
                    Jelaskan konsep tokoh Anda, pilih peran & era, lalu klik "Buat Tokoh!"
                </p>
                <!-- Generated figure details will appear here -->
                <div id="figure-description" class="mb-4 text-base leading-relaxed"></div>
            </div>
            
            <div class="flex flex-col sm:flex-row gap-4 justify-center mt-4">
                <button id="copy-figure-desc-btn" class="comic-button bg-blue-500 text-white px-8 py-3 rounded-full text-lg font-bold default-font hidden">
                    Salin Deskripsi Tokoh
                </button>
                <button id="clear-output-btn" class="comic-button bg-red-500 text-white px-8 py-3 rounded-full text-lg font-bold default-font hidden">
                    Bersihkan
                </button>
            </div>
        </div>
    </div>

    <!-- Full-screen loading overlay -->
    <div id="full-loading-overlay" class="loading-overlay-full">
        <div class="loader ease-linear rounded-full border-8 border-t-8 border-white h-20 w-20 mb-4"></div>
        <span id="overlay-message" class="comic-font">Membentuk legenda...</span>
    </div>

    <!-- Custom Alert/Confirm Modal -->
    <div id="custom-modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title" class="comic-font"></h3>
            <p id="modal-message"></p>
            <div class="modal-buttons">
                <button id="modal-confirm-btn" class="comic-button bg-blue-500 text-white px-6 py-2 rounded-full text-lg font-bold hidden">OK</button>
                <button id="modal-cancel-btn" class="comic-button bg-red-500 text-white px-6 py-2 rounded-full text-lg font-bold hidden">Batal</button>
            </div>
        </div>
    </div>

    <script>
        // API Key will be loaded from localStorage, default is blank.
        let API_KEY = localStorage.getItem('geminiApiKeyHistoricalFigure') || ""; 

        const apiKeyInput = document.getElementById('api-key-input');
        const saveApiKeyBtn = document.getElementById('save-api-key-btn');
        const apiKeySection = document.getElementById('api-key-section');
        const mainContent = document.getElementById('main-content'); // Main content container

        const figureConceptInput = document.getElementById('figure-concept-input');
        const randomConceptBtn = document.getElementById('random-concept-btn');
        const randomConceptButtonText = document.getElementById('random-concept-button-text');
        const randomConceptLoadingSpinner = document.getElementById('random-concept-loading-spinner');

        const figureRoleSelect = document.getElementById('figure-role-select');
        const figureEraSelect = document.getElementById('figure-era-select');
        const figureContextInput = document.getElementById('figure-context-input');
        const generateFigureBtn = document.getElementById('generate-figure-btn');
        const copyFigureDescBtn = document.getElementById('copy-figure-desc-btn');
        const clearOutputBtn = document.getElementById('clear-output-btn');
        
        const buttonText = document.getElementById('button-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        const figureOutputSection = document.getElementById('figure-output-section');
        const initialMessage = document.getElementById('initial-message');
        const figureDescriptionDiv = document.getElementById('figure-description');
        const fullLoadingOverlay = document.getElementById('full-loading-overlay');
        const overlayMessage = document.getElementById('overlay-message');

        // Modal elements
        const customModal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');

        const loadingMessages = [
            "Membentuk legenda...",
            "Mengukir prasasti...",
            "Menyelami kronik lama...",
            "Mencari jejak pahlawan...",
            "Merajut kisah masa lalu..."
        ];

        const randomConceptLoadingMessages = [
            "Mencari ide tokoh...",
            "Mengacak figur sejarah...",
            "Membangkitkan legenda..."
        ];

        // --- Custom Modal Functions (replaces alert/confirm) ---
        function showModal(title, message, type = 'alert') {
            return new Promise((resolve) => {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                customModal.classList.add('active');

                modalConfirmBtn.classList.remove('hidden');
                modalConfirmBtn.onclick = () => {
                    customModal.classList.remove('active');
                    resolve(true);
                };

                if (type === 'confirm') {
                    modalCancelBtn.classList.remove('hidden');
                    modalCancelBtn.onclick = () => {
                        customModal.classList.remove('active');
                        resolve(false);
                    };
                } else {
                    modalCancelBtn.classList.add('hidden');
                }
            });
        }

        // --- API Key Handling & Validation ---
        async function validateAndLoadApiKey(key) {
            if (!key) {
                await showModal('Peringatan!', 'API Key tidak boleh kosong.');
                return false;
            }

            console.log("DEBUG: Validating API Key for Historical Figure Generator:", key.substring(0, 5) + "...");
            try {
                let chatHistory = [{ role: "user", parts: [{ text: "Hello" }] }]; // Minimal prompt
                const payload = { contents: chatHistory };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json(); 
                    const errorMessage = errorBody.error ? errorBody.error.message : 'Unknown error';
                    await showModal('Validasi Gagal!', `API Key tidak valid: ${errorMessage}.`);
                    console.error("API Key validation failed for Historical Figure Generator:", response.status, errorBody);
                    return false;
                }
                const result = await response.json();
                if (!result.candidates || result.candidates.length === 0) {
                     await showModal('Validasi Gagal!', 'API Key valid namun respons tidak sesuai. Coba lagi atau periksa key Anda.');
                     console.error("API Key valid but unexpected response for Historical Figure Generator:", result);
                     return false;
                }
                console.log("DEBUG: API Key for Historical Figure Generator validated successfully.");
                return true;
            } catch (error) {
                await showModal('Validasi Gagal!', `Terjadi kesalahan koneksi saat validasi API Key: ${error.message}.`);
                console.error("Error during API Key validation for Historical Figure Generator:", error);
                return false;
            }
        }

        async function loadAndDisplayApiKey() {
            const storedKey = localStorage.getItem('geminiApiKeyHistoricalFigure');
            if (storedKey) {
                API_KEY = storedKey;
                apiKeyInput.value = storedKey; // Display the full key
                const isValid = await validateAndLoadApiKey(API_KEY);
                if (isValid) {
                    apiKeySection.classList.add('hidden'); 
                    mainContent.classList.remove('hidden'); 
                    console.log("DEBUG: API Key for Historical Figure Generator loaded from localStorage and is valid.");
                } else {
                    apiKeySection.classList.remove('hidden'); 
                    mainContent.classList.add('hidden'); 
                    console.log("DEBUG: Stored API Key for Historical Figure Generator is invalid. Please re-enter.");
                }
            } else {
                apiKeyInput.value = ""; // Ensure input is empty if no key
                apiKeySection.classList.remove('hidden'); // Ensure API key input is visible
                mainContent.classList.add('hidden'); // Ensure main content is hidden
                console.log("DEBUG: No API Key found in localStorage for Historical Figure Generator. Please enter it.");
            }
        }

        saveApiKeyBtn.addEventListener('click', async () => {
            const key = apiKeyInput.value.trim();
            if (key) {
                const isValid = await validateAndLoadApiKey(key);
                if (isValid) {
                    localStorage.setItem('geminiApiKeyHistoricalFigure', key);
                    API_KEY = key;
                    await showModal('Berhasil!', 'API Key berhasil disimpan dan diverifikasi!');
                    apiKeySection.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                } else {
                    // validateAndLoadApiKey already showed a modal for invalid key
                }
            } else {
                await showModal('Kesalahan!', 'Masukkan API Key terlebih dahulu!');
            }
        });

        // Function to show loading state for main generation
        function showLoading() {
            overlayMessage.textContent = loadingMessages[Math.floor(Math.random() * loadingMessages.length)];
            fullLoadingOverlay.classList.add('active');
            generateFigureBtn.disabled = true;
            randomConceptBtn.disabled = true;
            figureConceptInput.disabled = true;
            figureRoleSelect.disabled = true;
            figureEraSelect.disabled = true;
            figureContextInput.disabled = true;
            copyFigureDescBtn.classList.add('hidden');
            clearOutputBtn.classList.add('hidden');
            buttonText.textContent = "Membuat...";
            loadingSpinner.classList.remove('hidden');
            figureDescriptionDiv.innerHTML = '';
            initialMessage.classList.add('hidden');
        }

        // Function to hide loading state for main generation
        function hideLoading() {
            fullLoadingOverlay.classList.remove('active');
            generateFigureBtn.disabled = false;
            randomConceptBtn.disabled = false;
            figureConceptInput.disabled = false;
            figureRoleSelect.disabled = false;
            figureEraSelect.disabled = false;
            figureContextInput.disabled = false;
            copyFigureDescBtn.classList.remove('hidden');
            clearOutputBtn.classList.remove('hidden');
            buttonText.textContent = "Buat Tokoh!";
            loadingSpinner.classList.add('hidden');
        }

        // Function to show loading state for random concept generation
        function showRandomConceptLoading() {
            randomConceptButtonText.textContent = "Mengacak...";
            randomConceptLoadingSpinner.classList.remove('hidden');
            randomConceptBtn.disabled = true;
            generateFigureBtn.disabled = true;
            figureConceptInput.disabled = true;
        }

        // Function to hide loading state for random concept generation
        function hideRandomConceptLoading() {
            randomConceptButtonText.textContent = "Acak Konsep!";
            randomConceptLoadingSpinner.classList.add('hidden');
            randomConceptBtn.disabled = false;
            generateFigureBtn.disabled = false;
            figureConceptInput.disabled = false;
        }

        // Function to copy text to clipboard
        async function copyToClipboard(text, alertMessage = 'Teks berhasil disalin ke clipboard!') {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.top = 0;
            textarea.style.left = 0;
            textarea.style.width = '1px';
            textarea.style.height = '1px';
            textarea.style.opacity = 0;
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            try {
                document.execCommand('copy');
                await showModal('Berhasil!', alertMessage);
            } catch (err) {
                console.error('Gagal menyalin teks: ', err);
                await showModal('Gagal!', 'Gagal menyalin. Silakan salin manual.');
            } finally {
                document.body.removeChild(textarea);
            }
        }

        // Function to render the figure output from JSON
        function renderFigureDetails(figureData) {
            let htmlContent = '';
            if (figureData.name) {
                htmlContent += `<h3 class="text-2xl font-bold mb-4 text-center comic-font">${figureData.name}</h3>`;
            }
            if (figureData.title) {
                htmlContent += `<div class="detail-section"><strong>Julukan/Gelar:</strong><p class="default-font">${figureData.title}</p></div>`;
            }
            if (figureData.era) {
                htmlContent += `<div class="detail-section"><strong>Era:</strong><p class="default-font">${figureData.era}</p></div>`;
            }
            if (figureData.briefBio) {
                htmlContent += `<div class="detail-section"><strong>Biografi Singkat:</strong><p class="default-font">${figureData.briefBio}</p></div>`;
            }
            if (figureData.achievementsFailures) {
                htmlContent += `<div class="detail-section"><strong>Pencapaian/Kegagalan Kunci:</strong><p class="default-font">${figureData.achievementsFailures}</p></div>`;
            }
            if (figureData.notableTraits) {
                htmlContent += `<div class="detail-section"><strong>Sifat Khas:</strong><p class="default-font">${figureData.notableTraits}</p></div>`;
            }
            if (figureData.plotHooksLegacies && figureData.plotHooksLegacies.length > 0) {
                htmlContent += `<div class="detail-section"><strong>Potensi Plot Hooks/Warisan:</strong><ul>`;
                figureData.plotHooksLegacies.forEach(hook => {
                    htmlContent += `<li class="default-font">${hook}</li>`;
                });
                htmlContent += `</ul></div>`;
            }
            
            figureDescriptionDiv.innerHTML = htmlContent;
        }

        // Function to get raw text for copying
        function getRawFigureContent(figureData) {
            let rawText = '';
            if (figureData.name) rawText += `Nama Tokoh: ${figureData.name}\n\n`;
            if (figureData.title) rawText += `Julukan/Gelar:\n${figureData.title}\n\n`;
            if (figureData.era) rawText += `Era:\n${figureData.era}\n\n`;
            if (figureData.briefBio) rawText += `Biografi Singkat:\n${figureData.briefBio}\n\n`;
            if (figureData.achievementsFailures) rawText += `Pencapaian/Kegagalan Kunci:\n${figureData.achievementsFailures}\n\n`;
            if (figureData.notableTraits) rawText += `Sifat Khas:\n${figureData.notableTraits}\n\n`;
            if (figureData.plotHooksLegacies && figureData.plotHooksLegacies.length > 0) {
                rawText += `Potensi Plot Hooks/Warisan:\n`;
                figureData.plotHooksLegacies.forEach((hook, index) => {
                    rawText += `${index + 1}. ${hook}\n`;
                });
                rawText += `\n`;
            }
            return rawText.trim();
        }

        // Core Function: Generate Historical Figure
        async function generateFigure() {
            if (!API_KEY) {
                await showModal('Peringatan!', "Mohon masukkan API Key Gemini Anda terlebih dahulu dan simpan!");
                apiKeySection.classList.remove('hidden');
                mainContent.classList.add('hidden');
                return;
            }

            const figureConcept = figureConceptInput.value.trim();
            const figureRole = figureRoleSelect.value;
            const figureEra = figureEraSelect.value;
            const figureContext = figureContextInput.value.trim();

            if (!figureConcept) {
                await showModal('Peringatan!', 'Silakan jelaskan konsep tokoh Anda, atau klik "Acak Konsep!" untuk ide.');
                return;
            }

            showLoading();

            try {
                let prompt = `Sebagai seorang pencipta dunia fiksi, buatkan deskripsi mendalam untuk tokoh sejarah atau legenda berdasarkan konsep berikut: "${figureConcept}".
                
                Peran Tokoh: ${figureRole}
                Era/Periode: ${figureEra}
                ${figureContext ? `Konteks Tambahan: ${figureContext}` : 'Konteks Tambahan: (Asumsikan relevan dengan konsep tokoh)'}

                Detail yang diminta:
                -   Nama Tokoh: Sebuah nama yang relevan dan menarik.
                -   Julukan/Gelar: Julukan atau gelar yang dikenal.
                -   Era: Periode waktu keberadaan tokoh.
                -   Biografi Singkat: Ringkasan kehidupan dan asal-usul tokoh.
                -   Pencapaian/Kegagalan Kunci: Peristiwa penting yang dilakukan tokoh (positif atau negatif).
                -   Sifat Khas: Karakteristik atau kepribadian yang menonjol.
                -   Potensi Plot Hooks/Warisan: 1-3 ide konflik, misteri, atau konsekuensi jangka panjang dari keberadaan tokoh ini dalam cerita.

                Format respons Anda sebagai JSON object tunggal dengan properti berikut, semua dalam Bahasa Indonesia:
                {
                  "name": "STRING",
                  "title": "STRING",
                  "era": "STRING",
                  "briefBio": "STRING",
                  "achievementsFailures": "STRING",
                  "notableTraits": "STRING",
                  "plotHooksLegacies": ["STRING", "STRING", "STRING"] // Array of strings for plot hooks/legacies
                }
                `;
                console.log("DEBUG: generateFigure prompt:", prompt);

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = { 
                    contents: chatHistory,
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "name": { "type": "STRING" },
                                "title": { "type": "STRING" },
                                "era": { "type": "STRING" },
                                "briefBio": { "type": "STRING" },
                                "achievementsFailures": { "type": "STRING" },
                                "notableTraits": { "type": "STRING" },
                                "plotHooksLegacies": {
                                    "type": "ARRAY",
                                    "items": { "type": "STRING" }
                                }
                            },
                            "required": ["name", "briefBio", "plotHooksLegacies"]
                        }
                    }
                };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error("API Response not OK for Figure Generation:", response.status, errorBody);
                    try {
                        const errorData = typeof errorBody === 'string' ? JSON.parse(errorBody) : errorBody;
                        await showModal('Kesalahan API!', `API Error (${response.status}): ${errorData.error.message || 'Unknown error'}. Pastikan API Key valid.`);
                    } catch (parseError) {
                        await showModal('Kesalahan API!', `API Error (${response.status}): ${response.statusText}. Response: ${JSON.stringify(errorBody).substring(0, 100)}...`);
                    }
                    throw new Error(`API response was not ok: ${response.status} ${response.statusText} - ${JSON.stringify(errorBody)}`);
                }

                const result = await response.json();
                console.log("DEBUG: Figure Raw Result:", result);
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const figureData = JSON.parse(result.candidates[0].content.parts[0].text);
                    console.log("DEBUG: Parsed Figure Data:", figureData);
                    renderFigureDetails(figureData);
                    figureOutputSection.currentFigureData = figureData; // Store for copying

                } else {
                    figureOutputSection.innerHTML = `
                        <p class="text-center text-red-700 comic-font text-lg pt-10">
                            Maaf, AI gagal membuat detail tokoh. Pastikan konsep Anda jelas dan spesifik.
                        </p>
                    `;
                    console.error("AI failed to generate figure (missing candidates/content). Result:", result);
                }
            } catch (error) {
                figureOutputSection.innerHTML = `
                    <p class="text-center text-red-700 comic-font text-lg pt-10">
                        Terjadi kesalahan saat memuat detail tokoh. Periksa koneksi Anda atau API Key Anda.
                    </p>
                `;
                console.error("ERROR fetching figure data:", error);
                if (!document.getElementById('custom-modal').classList.contains('active')) {
                    await showModal('Kesalahan!', `Terjadi kesalahan saat membuat tokoh: ${error.message}. Pastikan API Key Anda valid.`);
                }
            } finally {
                hideLoading();
            }
        }

        // New Function: Generate Random Concept for Historical Figure
        async function generateRandomConcept() {
            if (!API_KEY) {
                await showModal('Peringatan!', "Mohon masukkan API Key Gemini Anda terlebih dahulu dan simpan!");
                apiKeySection.classList.remove('hidden'); 
                mainContent.classList.add('hidden'); 
                return;
            }

            showRandomConceptLoading();

            try {
                const prompt = `Berikan SATU ide konsep tokoh sejarah atau legenda fiksi yang singkat, menarik, dan unik dalam MAKSIMAL dua kalimat. Fokus pada inti perannya atau peristiwa penting yang terkait dengannya. Hindari referensi langsung ke agama atau dewa. Berikan hanya konsepnya sebagai teks biasa, tanpa awalan atau contoh, dan tanpa daftar bernomor atau bullet point.`;
                
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = { contents: chatHistory };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error("API Response not OK for Random Concept Generation:", response.status, errorBody);
                    try {
                        const errorData = typeof errorBody === 'string' ? JSON.parse(errorBody) : errorBody;
                        await showModal('Kesalahan API!', `API Error (${response.status}): ${errorData.error.message || 'Unknown error'}. Pastikan API Key valid.`);
                    } catch (parseError) {
                        await showModal('Kesalahan API!', `API Error (${response.status}): ${response.statusText}. Response: ${JSON.stringify(errorBody).substring(0, 100)}...`);
                    }
                    throw new Error(`API response was not ok: ${response.status} ${response.statusText} - ${JSON.stringify(errorBody)}`);
                }

                const result = await response.json();
                console.log("DEBUG: Random Concept Raw Result:", result);

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const generatedConcept = result.candidates[0].content.parts[0].text.trim();
                    figureConceptInput.value = generatedConcept;
                } else {
                    await showModal('Gagal!', 'AI gagal menghasilkan konsep acak. Coba lagi.');
                    console.error("AI failed to generate random concept (missing candidates/content). Result:", result);
                }

            } catch (error) {
                await showModal('Kesalahan!', `Terjadi kesalahan saat mengacak konsep: ${error.message}.`);
                console.error("ERROR generating random concept:", error);
            } finally {
                hideRandomConceptLoading();
            }
        }

        // --- Event Listeners ---
        generateFigureBtn.addEventListener('click', generateFigure);
        randomConceptBtn.addEventListener('click', generateRandomConcept);

        copyFigureDescBtn.addEventListener('click', async () => {
            if (figureOutputSection.currentFigureData) {
                const rawText = getRawFigureContent(figureOutputSection.currentFigureData);
                await copyToClipboard(rawText, 'Deskripsi tokoh berhasil disalin!');
            } else {
                await showModal('Peringatan!', 'Tidak ada deskripsi tokoh untuk disalin.');
            }
        });

        clearOutputBtn.addEventListener('click', async () => {
            const confirmed = await showModal('Konfirmasi', 'Anda yakin ingin menghapus detail tokoh yang ditampilkan dan input?', 'confirm');
            if (confirmed) {
                figureConceptInput.value = '';
                figureRoleSelect.value = 'Pahlawan';
                figureEraSelect.value = 'Tidak Diketahui/Mitos';
                figureContextInput.value = '';
                figureDescriptionDiv.innerHTML = '';
                initialMessage.classList.remove('hidden');
                copyFigureDescBtn.classList.add('hidden');
                clearOutputBtn.classList.add('hidden');
                figureOutputSection.currentFigureData = null;
            }
        });

        // Initial setup on page load
        window.onload = loadAndDisplayApiKey;
    </script>
</body>
</html>

